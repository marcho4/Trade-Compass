# Пояснительная записка к базе данных проекта Trade Compass

## 1. Назначение и целевая аудитория

### 1.1 Описание системы

**Trade Compass** — веб-приложение для анализа акций российских компаний с AI-ассистентом. Система позволяет инвесторам отслеживать финансовые показатели компаний, управлять инвестиционными портфелями и получать AI-анализ отчетности.

### 1.2 Целевая аудитория

| Категория пользователей | Описание | Сценарии использования |
|------------------------|----------|------------------------|
| Частные инвесторы | Физические лица, инвестирующие на фондовом рынке | Анализ компаний перед покупкой, отслеживание портфеля |
| Начинающие трейдеры | Пользователи, только начинающие инвестировать | Обучение через AI-объяснения терминов и показателей |
| Финансовые аналитики | Профессионалы, работающие с отчетностью компаний | Быстрый доступ к метрикам, сравнение компаний |
| Финансовые консультанты | Специалисты, помогающие клиентам с инвестициями | Подготовка аналитических отчетов для клиентов |

### 1.3 Основные сценарии использования

1. **Скрининг компаний** — фильтрация и поиск компаний по финансовым показателям
2. **Анализ компании** — просмотр детальной финансовой информации
3. **Управление портфелем** — добавление/удаление позиций, отслеживание доходности
4. **AI-анализ** — получение автоматизированного анализа финансовой отчетности
5. **Отслеживание дивидендов** — мониторинг дивидендных выплат

---

## 2. Функциональные требования

### FR-1: Управление пользователями
- FR-1.1: Система должна позволять регистрацию по email/password
- FR-1.2: Система должна поддерживать OAuth-авторизацию (Yandex, Google)
- FR-1.3: Система должна управлять сессиями через refresh-токены
- FR-1.4: Система должна поддерживать несколько устройств одновременно

### FR-2: Управление компаниями
- FR-2.1: Система должна хранить информацию о публичных компаниях
- FR-2.2: Система должна группировать компании по секторам экономики
- FR-2.3: Система должна хранить финансовые отчеты компаний (квартальные и годовые)

### FR-3: Финансовые метрики
- FR-3.1: Система должна хранить данные P&L, Balance Sheet, Cash Flow
- FR-3.2: Система должна рассчитывать финансовые коэффициенты (P/E, ROE, и др.)
- FR-3.3: Система должна отслеживать дивидендные выплаты

### FR-4: Управление портфелями
- FR-4.1: Пользователь должен иметь возможность создавать несколько портфелей
- FR-4.2: Система должна хранить позиции (компания, количество, средняя цена)
- FR-4.3: Система должна рассчитывать P&L по портфелю

### FR-5: AI-анализ
- FR-5.1: Система должна предоставлять AI-анализ финансовых отчетов
- FR-5.2: Система должна кэшировать результаты AI-анализа
- FR-5.3: Система должна отслеживать стоимость AI-запросов

### FR-6: Подписки
- FR-6.1: Система должна поддерживать уровни подписки (Free, Premium, Pro)
- FR-6.2: Система должна ограничивать функционал в зависимости от подписки

---

## 3. Нефункциональные требования

### NFR-1: Производительность
- Время отклика API < 200ms для 95% запросов
- Поддержка до 10,000 одновременных пользователей
- Кэширование AI-анализа для снижения нагрузки

### NFR-2: Безопасность
- Хранение паролей в виде bcrypt-хешей
- JWT токены в HttpOnly cookies
- Rate limiting на попытки авторизации (5 попыток)
- HTTPS для всех соединений

### NFR-3: Надежность
- Доступность системы 99.5%
- Резервное копирование БД каждые 6 часов
- Транзакционная целостность операций с портфелем

### NFR-4: Масштабируемость
- Горизонтальное масштабирование через микросервисы
- Партиционирование таблицы metrics по годам
- Индексирование часто используемых полей

---

## 4. Схема базы данных (ER-диаграмма)

### 4.1 Диаграмма сущностей и связей

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              АУТЕНТИФИКАЦИЯ                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────┐         ┌──────────────┐         ┌──────────────────┐    │
│  │    users     │────1:1──│     auth     │         │  provider_auth   │    │
│  ├──────────────┤         ├──────────────┤         ├──────────────────┤    │
│  │ PK id        │         │ FK user_id   │         │ PK id            │    │
│  │    name      │         │    email     │         │ FK user_id       │    │
│  │    status    │         │    password_ │         │    provider_type │    │
│  │    last_     │         │    hash      │         │    provider_     │    │
│  │    login_at  │         └──────────────┘         │    user_id       │    │
│  │    created_  │                                  │    email         │    │
│  │    at        │────1:N──┐                        └──────────────────┘    │
│  │    updated_  │         │                                 ▲              │
│  │    at        │         │                                 │              │
│  └──────────────┘         │                               1:N              │
│         │                 │                                 │              │
│         │                 ▼                                 │              │
│         │         ┌──────────────────┐                      │              │
│         │         │  refresh_tokens  │──────────────────────┘              │
│         │         ├──────────────────┤                                     │
│         │         │ PK id            │                                     │
│         │         │ FK user_id       │                                     │
│         │         │    token_hash    │                                     │
│         │         │    device_info   │                                     │
│         │         │    expires_at    │                                     │
│         │         └──────────────────┘                                     │
│         │                                                                   │
│       1:N                                                                   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌──────────────────┐        ┌──────────────────┐                          │
│  │   subscriptions  │        │     portfolio    │◄─────────────────┐       │
│  ├──────────────────┤        ├──────────────────┤                  │       │
│  │ PK id            │        │ PK id            │                  │       │
│  │ FK user_id       │        │ FK user_id       │                1:N       │
│  │    level         │        │    name          │                  │       │
│  │    start_date    │        │    description   │                  │       │
│  │    end_date      │        │    created_at    │                  │       │
│  └──────────────────┘        └──────────────────┘                  │       │
│                                      │                             │       │
│                                    1:N                             │       │
│                                      ▼                             │       │
│                              ┌──────────────────┐                  │       │
│                              │     position     │                  │       │
│                              ├──────────────────┤                  │       │
│                              │ PK id            │                  │       │
│                              │ FK portfolio_id  │                  │       │
│                              │ FK company_id    │───────┐          │       │
│                              │    avg_price     │       │          │       │
│                              │    quantity      │       │          │       │
│                              │    last_buy_date │       │          │       │
│                              └──────────────────┘       │          │       │
│                                                         │          │       │
└─────────────────────────────────────────────────────────│──────────│───────┘
                                                          │          │
┌─────────────────────────────────────────────────────────│──────────│───────┐
│                           КОМПАНИИ И ОТЧЕТНОСТЬ         │          │       │
├─────────────────────────────────────────────────────────│──────────│───────┤
│                                                         │          │       │
│  ┌──────────────┐         ┌──────────────┐              │          │       │
│  │   sectors    │────1:N──│  companies   │◄─────────────┘          │       │
│  ├──────────────┤         ├──────────────┤                         │       │
│  │ PK id        │         │ PK id        │                         │       │
│  │    name      │         │    inn       │                         │       │
│  └──────────────┘         │    ticker    │◄────────────────────────┘       │
│                           │    name      │                                 │
│                           │    owner     │                                 │
│                           │ FK sector_id │                                 │
│                           │    lot_size  │                                 │
│                           │    employees │                                 │
│                           │    ceo       │                                 │
│                           └──────────────┘                                 │
│                                   │                                        │
│                    ┌──────────────┼──────────────┐                         │
│                  1:N            1:N            1:N                         │
│                    ▼              ▼              ▼                         │
│            ┌────────────┐  ┌────────────┐  ┌────────────────┐              │
│            │  reports   │  │ dividends  │  │  ai_analyses   │              │
│            ├────────────┤  ├────────────┤  ├────────────────┤              │
│            │ PK id      │  │ PK id      │  │ PK id          │              │
│            │ FK company │  │ FK company │  │ FK company_id  │              │
│            │    _id     │  │    _id     │  │ FK report_id   │              │
│            │    report_ │  │    ex_div_ │  │    analysis_   │              │
│            │    year    │  │    date    │  │    type        │              │
│            │    report_ │  │    payment_│  │    prompt_hash │              │
│            │    period  │  │    date    │  │    response_   │              │
│            │    storage_│  │    amount  │  │    text        │              │
│            │    url     │  │    yield   │  │    tokens_used │              │
│            └────────────┘  │    payout_ │  │    cost_usd    │              │
│                   │        │    ratio   │  │    cache_until │              │
│        ┌──────────┴──────┐ └────────────┘  └────────────────┘              │
│      1:1               1:1                                                 │
│        ▼                 ▼                                                 │
│  ┌────────────┐   ┌────────────┐                                           │
│  │  metrics   │   │ indicators │                                           │
│  ├────────────┤   ├────────────┤                                           │
│  │ FK report_ │   │ FK report_ │                                           │
│  │    id      │   │    id      │                                           │
│  │ (P&L data) │   │ (Ratios)   │                                           │
│  │ (Balance)  │   │ (Margins)  │                                           │
│  │ (CashFlow) │   │ (Growth)   │                                           │
│  └────────────┘   └────────────┘                                           │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Описание сущностей

| Сущность | Описание | Ключевые атрибуты |
|----------|----------|-------------------|
| **users** | Зарегистрированные пользователи | id, name, status, last_login_at |
| **auth** | Аутентификация по email/password | user_id (PK,FK), email, password_hash |
| **provider_auth** | OAuth провайдеры | id, user_id, provider_type, provider_user_id |
| **refresh_tokens** | Токены обновления сессий | id, user_id, token_hash, expires_at |
| **subscriptions** | Подписки пользователей | id, user_id, level, start_date, end_date |
| **portfolio** | Инвестиционные портфели | id, user_id, name, description |
| **position** | Позиции в портфеле | id, portfolio_id, company_id, avg_price, quantity |
| **sectors** | Секторы экономики | id, name |
| **companies** | Публичные компании | id, inn, ticker, name, sector_id |
| **reports** | Финансовые отчеты | id, company_id, report_year, report_period |
| **metrics** | Финансовые показатели | report_id, revenue, netProfit, totalAssets... |
| **indicators** | Расчетные коэффициенты | report_id, pe, roe, roa, debtToEquity... |
| **dividends** | Дивидендные выплаты | id, company_id, ex_dividend_date, amount |
| **ai_analyses** | Кэш AI-анализа | id, company_id, report_id, response_text, cost |

---

## 5. Текстовые ограничения на данные

### 5.1 Ограничения сущностей

#### Пользователи и аутентификация:
1. Каждый пользователь имеет **ровно один** профиль в таблице `users`
2. Пользователь может иметь **0 или 1** запись в `auth` (email-аутентификация)
3. Пользователь может иметь **0 или более** записей в `provider_auth` (OAuth)
4. Пользователь должен иметь **хотя бы один** способ аутентификации (auth ИЛИ provider_auth)
5. Каждый refresh_token принадлежит **ровно одному** пользователю
6. Пользователь может иметь **0 или более** активных refresh_tokens (мультидевайс)

#### Компании и отчетность:
7. Каждая компания принадлежит **ровно одному** сектору
8. Сектор может содержать **0 или более** компаний
9. Компания может иметь **0 или более** финансовых отчетов
10. Каждый отчет принадлежит **ровно одной** компании
11. Каждый отчет имеет **ровно одну** запись в `metrics`
12. Каждый отчет имеет **ровно одну** запись в `indicators`
13. Для одной компании может быть **только один** отчет за конкретный период (год + квартал)

#### Портфели и позиции:
14. Каждый портфель принадлежит **ровно одному** пользователю
15. Пользователь может иметь **0 или более** портфелей
16. У одного пользователя не может быть двух портфелей с одинаковым названием
17. Каждая позиция принадлежит **ровно одному** портфелю
18. Позиция ссылается на **ровно одну** компанию
19. В одном портфеле не может быть двух позиций по одной компании

#### Подписки и AI:
20. Пользователь может иметь **0 или более** подписок (история)
21. Активная подписка — та, где `start_date <= NOW() < end_date`
22. AI-анализ связан с **ровно одной** компанией и **0 или 1** отчетом
23. Кэш AI-анализа валиден до `cache_until`

#### Дивиденды:
24. Каждая дивидендная выплата относится к **ровно одной** компании
25. Компания может иметь **0 или более** дивидендных выплат

---

## 6. Функциональные и многозначные зависимости

### 6.1 Функциональные зависимости (FD)

#### Таблица users:
```
FD1: id → name, status, last_login_at, created_at, updated_at
```

#### Таблица auth:
```
FD2: user_id → email, password_hash
FD3: email → user_id, password_hash
```

#### Таблица provider_auth:
```
FD4: id → user_id, provider_type, provider_user_id, email
FD5: (provider_type, provider_user_id) → id, user_id, email
```

#### Таблица refresh_tokens:
```
FD6: id → user_id, token_hash, device_info, created_at, updated_at, expires_at
FD7: token_hash → id, user_id, device_info, created_at, updated_at, expires_at
```

#### Таблица sectors:
```
FD8: id → name
FD9: name → id
```

#### Таблица companies:
```
FD10: id → inn, ticker, name, owner, sector_id, lot_size, employees, ceo
FD11: ticker → id, inn, name, owner, sector_id, lot_size, employees, ceo
FD12: inn → id, ticker, name, owner, sector_id, lot_size, employees, ceo
```

#### Таблица reports:
```
FD13: id → company_id, report_year, report_period, report_storage_url
FD14: (company_id, report_year, report_period) → id, report_storage_url
```

#### Таблица metrics:
```
FD15: report_id → revenue, costOfRevenue, grossProfit, ..., freeCashFlow
```

#### Таблица indicators:
```
FD16: report_id → pe, pb, ps, peg, roe, roa, ..., epsGrowthYoy
```

#### Таблица portfolio:
```
FD17: id → user_id, name, description, created_at, updated_at
FD18: (user_id, name) → id, description, created_at, updated_at
```

#### Таблица position:
```
FD19: id → portfolio_id, company_id, avg_price, quantity, last_buy_date
FD20: (portfolio_id, company_id) → id, avg_price, quantity, last_buy_date
```

#### Таблица subscriptions:
```
FD21: id → user_id, level, start_date, end_date
```

#### Таблица dividends:
```
FD22: id → company_id, ex_dividend_date, payment_date, amount_per_share, dividend_yield, payout_ratio
```

#### Таблица ai_analyses:
```
FD23: id → company_id, report_id, analysis_type, prompt_hash, response_text, tokens_used, cost_usd, created_at, cache_until
FD24: prompt_hash → id, company_id, report_id, analysis_type, response_text, tokens_used, cost_usd, created_at, cache_until
```

### 6.2 Многозначные зависимости (MVD)

В данной схеме многозначные зависимости минимальны благодаря нормализации:

```
MVD1: user_id ↠ portfolio_id | subscription_id
      (Пользователь независимо может иметь несколько портфелей и несколько подписок)

MVD2: company_id ↠ report_id | dividend_id
      (Компания независимо может иметь несколько отчетов и несколько дивидендов)

MVD3: user_id ↠ refresh_token_id | provider_auth_id
      (Пользователь независимо может иметь несколько токенов и провайдеров)
```

---

## 7. Нормализация схемы БД

### 7.1 Анализ текущей нормализации

#### Первая нормальная форма (1NF) ✓
- Все атрибуты атомарны (нет составных или многозначных атрибутов)
- Каждая таблица имеет первичный ключ
- Нет повторяющихся групп

#### Вторая нормальная форма (2NF) ✓
- Все неключевые атрибуты полностью функционально зависят от первичного ключа
- Нет частичных зависимостей (все таблицы с составными ключами проверены)

#### Третья нормальная форма (3NF) ✓
- Нет транзитивных зависимостей
- Пример: `companies.sector_id` ссылается на `sectors.id`, а не хранит `sector_name` напрямую

#### Нормальная форма Бойса-Кодда (BCNF) ✓
- Для каждой функциональной зависимости X → Y, X является суперключом
- Все детерминанты являются ключами-кандидатами

### 7.2 Обоснование разделения таблиц

| Исходная концепция | Разделение | Обоснование |
|-------------------|------------|-------------|
| Пользователь + аутентификация | `users` + `auth` + `provider_auth` | Пользователь может иметь разные способы входа; избегаем NULL-полей |
| Компания + отчетность | `companies` + `reports` + `metrics` + `indicators` | Один отчет = одна запись; разделение по типу данных |
| Портфель + позиции | `portfolio` + `position` | Избегаем дублирования данных портфеля для каждой позиции |

---

## 8. Пример аномалии при недонормализации

### 8.1 Ненормализованная схема (для демонстрации)

Рассмотрим альтернативную, **ненормализованную** версию таблицы компаний:

```sql
-- ПЛОХОЙ ПРИМЕР: Ненормализованная таблица
CREATE TABLE companies_denormalized (
    id SERIAL PRIMARY KEY,
    ticker VARCHAR(10),
    company_name VARCHAR(200),
    sector_name VARCHAR(100),        -- Денормализация: хранится имя, а не FK
    sector_description TEXT,         -- Денормализация: дублируется описание

    -- Встроенные данные последнего отчета
    latest_revenue DECIMAL(15,2),
    latest_net_profit DECIMAL(15,2),
    latest_pe DECIMAL(10,2),
    latest_roe DECIMAL(10,4),

    -- Встроенные данные портфеля
    ceo VARCHAR(100)
);
```

### 8.2 Аномалия обновления (Update Anomaly)

**Сценарий:** Сектор "Нефть и газ" переименовывается в "Энергетика"

```sql
-- В ненормализованной схеме нужно обновить ВСЕ записи компаний сектора
UPDATE companies_denormalized
SET sector_name = 'Энергетика',
    sector_description = 'Компании энергетического сектора'
WHERE sector_name = 'Нефть и газ';
-- Проблема: если обновились не все записи — несогласованность данных!
```

**В нормализованной схеме:**
```sql
-- Достаточно обновить одну запись в таблице секторов
UPDATE sectors SET name = 'Энергетика' WHERE name = 'Нефть и газ';
-- Все компании автоматически "видят" новое название через FK
```

### 8.3 Аномалия вставки (Insert Anomaly)

**Сценарий:** Нужно добавить новый сектор "Криптовалюты" без компаний

```sql
-- В ненормализованной схеме НЕЛЬЗЯ добавить сектор без компании!
-- Придется создавать фиктивную компанию или оставлять NULL-значения

-- В нормализованной схеме:
INSERT INTO sectors (name) VALUES ('Криптовалюты');
-- Сектор существует независимо от наличия компаний
```

### 8.4 Аномалия удаления (Delete Anomaly)

**Сценарий:** Удаляем единственную компанию в секторе "Микроэлектроника"

```sql
-- В ненормализованной схеме:
DELETE FROM companies_denormalized WHERE ticker = 'MIKR';
-- Проблема: теряем информацию о секторе "Микроэлектроника"!

-- В нормализованной схеме:
DELETE FROM companies WHERE ticker = 'MIKR';
-- Сектор сохраняется в таблице sectors
```

### 8.5 Избыточность данных

| Аспект | Ненормализованная | Нормализованная |
|--------|-------------------|-----------------|
| Хранение названия сектора | Дублируется для каждой компании | Хранится 1 раз |
| Обновление сектора | N операций (N = кол-во компаний) | 1 операция |
| Целостность | Может нарушиться | Гарантирована FK |
| Размер БД | Больше из-за дублирования | Оптимальный |

---

## 9. SQL DDL — Создание схемы БД

```sql
-- ============================================
-- TRADE COMPASS DATABASE SCHEMA
-- PostgreSQL 17+
-- ============================================

-- Удаление существующих таблиц (для чистой установки)
DROP TABLE IF EXISTS ai_analyses CASCADE;
DROP TABLE IF EXISTS dividends CASCADE;
DROP TABLE IF EXISTS indicators CASCADE;
DROP TABLE IF EXISTS metrics CASCADE;
DROP TABLE IF EXISTS reports CASCADE;
DROP TABLE IF EXISTS position CASCADE;
DROP TABLE IF EXISTS portfolio CASCADE;
DROP TABLE IF EXISTS subscriptions CASCADE;
DROP TABLE IF EXISTS refresh_tokens CASCADE;
DROP TABLE IF EXISTS provider_auth CASCADE;
DROP TABLE IF EXISTS auth CASCADE;
DROP TABLE IF EXISTS companies CASCADE;
DROP TABLE IF EXISTS sectors CASCADE;
DROP TABLE IF EXISTS users CASCADE;

-- ============================================
-- ТИПЫ ДАННЫХ (ENUM)
-- ============================================

CREATE TYPE user_status AS ENUM ('active', 'blocked', 'deleted');
CREATE TYPE provider_type AS ENUM ('google', 'yandex');
CREATE TYPE subscription_level AS ENUM ('free', 'premium', 'pro');
CREATE TYPE report_period AS ENUM ('Q1', 'Q2', 'Q3', 'Q4', 'ANNUAL');
CREATE TYPE analysis_type AS ENUM ('full', 'quick', 'term_explanation');

-- ============================================
-- ТАБЛИЦЫ АУТЕНТИФИКАЦИИ
-- ============================================

-- Пользователи
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    status user_status NOT NULL DEFAULT 'active',
    last_login_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Email/Password аутентификация
CREATE TABLE auth (
    user_id BIGINT PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- OAuth провайдеры
CREATE TABLE provider_auth (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    provider_type provider_type NOT NULL,
    provider_user_id VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(provider_type, provider_user_id)
);

-- Refresh токены
CREATE TABLE refresh_tokens (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(64) NOT NULL UNIQUE,
    device_info VARCHAR(255),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    expires_at TIMESTAMPTZ NOT NULL
);

-- Подписки
CREATE TABLE subscriptions (
    id SERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    level subscription_level NOT NULL DEFAULT 'free',
    start_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    end_date TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ============================================
-- ТАБЛИЦЫ КОМПАНИЙ И ФИНАНСОВ
-- ============================================

-- Секторы экономики
CREATE TABLE sectors (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL UNIQUE,
    description TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Компании
CREATE TABLE companies (
    id SERIAL PRIMARY KEY,
    inn BIGINT UNIQUE,
    ticker VARCHAR(10) NOT NULL UNIQUE,
    name VARCHAR(200) NOT NULL,
    owner VARCHAR(200),
    sector_id INT REFERENCES sectors(id),
    lot_size INT DEFAULT 1,
    employees INT,
    ceo VARCHAR(100),
    website VARCHAR(255),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Финансовые отчеты
CREATE TABLE reports (
    id SERIAL PRIMARY KEY,
    company_id INT NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    report_year INT NOT NULL CHECK (report_year >= 2000 AND report_year <= 2100),
    report_period report_period NOT NULL,
    report_storage_url TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(company_id, report_year, report_period)
);

-- Финансовые метрики (P&L, Balance Sheet, Cash Flow)
CREATE TABLE metrics (
    report_id INT PRIMARY KEY REFERENCES reports(id) ON DELETE CASCADE,

    -- P&L Statement
    revenue DECIMAL(18,2),
    cost_of_revenue DECIMAL(18,2),
    gross_profit DECIMAL(18,2),
    operating_expenses DECIMAL(18,2),
    operating_income DECIMAL(18,2),  -- EBIT
    ebitda DECIMAL(18,2),
    interest_expense DECIMAL(18,2),
    tax_expense DECIMAL(18,2),
    net_profit DECIMAL(18,2),
    eps DECIMAL(10,4),

    -- Balance Sheet
    total_assets DECIMAL(18,2),
    current_assets DECIMAL(18,2),
    cash_and_equivalents DECIMAL(18,2),
    inventories DECIMAL(18,2),
    accounts_receivable DECIMAL(18,2),
    total_liabilities DECIMAL(18,2),
    current_liabilities DECIMAL(18,2),
    long_term_debt DECIMAL(18,2),
    short_term_debt DECIMAL(18,2),
    total_equity DECIMAL(18,2),
    retained_earnings DECIMAL(18,2),

    -- Cash Flow Statement
    operating_cash_flow DECIMAL(18,2),
    investing_cash_flow DECIMAL(18,2),
    financing_cash_flow DECIMAL(18,2),
    capex DECIMAL(18,2),
    free_cash_flow DECIMAL(18,2),

    -- Market Data
    shares_outstanding BIGINT,
    market_cap DECIMAL(18,2),
    share_price DECIMAL(10,4),

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Финансовые индикаторы (расчетные коэффициенты)
CREATE TABLE indicators (
    report_id INT PRIMARY KEY REFERENCES reports(id) ON DELETE CASCADE,

    -- Valuation Multiples
    pe DECIMAL(10,2),              -- Price / EPS
    pb DECIMAL(10,2),              -- Price / Book Value
    ps DECIMAL(10,2),              -- Price / Sales
    peg DECIMAL(10,2),             -- PE / Growth Rate

    -- Profitability Ratios
    roe DECIMAL(10,4),             -- Return on Equity
    roa DECIMAL(10,4),             -- Return on Assets
    roce DECIMAL(10,4),            -- Return on Capital Employed
    roic DECIMAL(10,4),            -- Return on Invested Capital

    -- Margin Ratios
    gross_profit_margin DECIMAL(10,4),
    operating_profit_margin DECIMAL(10,4),
    net_profit_margin DECIMAL(10,4),
    ebitda_margin DECIMAL(10,4),

    -- Enterprise Value Multiples
    ev_ebitda DECIMAL(10,2),
    ev_sales DECIMAL(10,2),
    ev_fcf DECIMAL(10,2),

    -- Liquidity Ratios
    current_ratio DECIMAL(10,2),
    quick_ratio DECIMAL(10,2),

    -- Leverage Ratios
    debt_to_equity DECIMAL(10,2),
    debt_to_ebitda DECIMAL(10,2),
    interest_coverage DECIMAL(10,2),

    -- Cash Flow Ratios
    fcf_yield DECIMAL(10,4),
    income_quality DECIMAL(10,4),  -- OCF / Net Income

    -- Growth Rates (YoY)
    revenue_growth_yoy DECIMAL(10,4),
    profit_growth_yoy DECIMAL(10,4),
    eps_growth_yoy DECIMAL(10,4),

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Дивиденды
CREATE TABLE dividends (
    id SERIAL PRIMARY KEY,
    company_id INT NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    ex_dividend_date DATE NOT NULL,
    payment_date DATE,
    amount_per_share DECIMAL(10,4) NOT NULL,
    dividend_yield DECIMAL(10,4),
    payout_ratio DECIMAL(10,4),
    currency VARCHAR(3) DEFAULT 'RUB',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(company_id, ex_dividend_date)
);

-- ============================================
-- ТАБЛИЦЫ ПОРТФЕЛЕЙ
-- ============================================

-- Портфели
CREATE TABLE portfolio (
    id SERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(user_id, name)
);

-- Позиции в портфеле
CREATE TABLE position (
    id SERIAL PRIMARY KEY,
    portfolio_id INT NOT NULL REFERENCES portfolio(id) ON DELETE CASCADE,
    company_id INT NOT NULL REFERENCES companies(id),
    avg_price DECIMAL(10,4) NOT NULL CHECK (avg_price > 0),
    quantity INT NOT NULL CHECK (quantity > 0),
    last_buy_date TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    UNIQUE(portfolio_id, company_id)
);

-- ============================================
-- ТАБЛИЦА AI-АНАЛИЗА
-- ============================================

CREATE TABLE ai_analyses (
    id SERIAL PRIMARY KEY,
    company_id INT NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    report_id INT REFERENCES reports(id) ON DELETE SET NULL,
    analysis_type analysis_type NOT NULL,
    prompt_hash VARCHAR(64) NOT NULL UNIQUE,
    response_text TEXT NOT NULL,
    tokens_used INT NOT NULL,
    cost_usd DECIMAL(8,4) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    cache_until TIMESTAMPTZ NOT NULL
);

-- ============================================
-- ИНДЕКСЫ
-- ============================================

-- Пользователи и аутентификация
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_auth_email ON auth(email);
CREATE INDEX idx_provider_auth_user_id ON provider_auth(user_id);
CREATE INDEX idx_refresh_tokens_user_id ON refresh_tokens(user_id);
CREATE INDEX idx_refresh_tokens_expires ON refresh_tokens(expires_at);

-- Компании
CREATE INDEX idx_companies_sector ON companies(sector_id);
CREATE INDEX idx_companies_ticker ON companies(ticker);

-- Отчеты и метрики
CREATE INDEX idx_reports_company ON reports(company_id);
CREATE INDEX idx_reports_year_period ON reports(report_year, report_period);

-- Дивиденды
CREATE INDEX idx_dividends_company ON dividends(company_id);
CREATE INDEX idx_dividends_date ON dividends(ex_dividend_date);

-- Портфели
CREATE INDEX idx_portfolio_user ON portfolio(user_id);
CREATE INDEX idx_position_portfolio ON position(portfolio_id);
CREATE INDEX idx_position_company ON position(company_id);

-- AI анализ
CREATE INDEX idx_ai_analyses_company ON ai_analyses(company_id);
CREATE INDEX idx_ai_analyses_cache ON ai_analyses(cache_until);

-- Подписки
CREATE INDEX idx_subscriptions_user ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_dates ON subscriptions(start_date, end_date);
```

---

## 10. SQL DML — Запросы для функциональных требований

### 10.1 Запросы для скрининга компаний

#### Запрос 1: Топ-10 компаний по P/E ratio с фильтрацией
```sql
-- Найти недооцененные компании (низкий P/E, положительная прибыль)
SELECT
    c.ticker,
    c.name,
    s.name AS sector,
    i.pe,
    i.roe,
    i.debt_to_equity,
    m.net_profit,
    m.revenue
FROM companies c
JOIN sectors s ON c.sector_id = s.id
JOIN reports r ON c.id = r.company_id
JOIN metrics m ON r.id = m.report_id
JOIN indicators i ON r.id = i.report_id
WHERE
    r.report_period = 'ANNUAL'
    AND r.report_year = EXTRACT(YEAR FROM CURRENT_DATE) - 1
    AND i.pe > 0
    AND i.pe < 15
    AND m.net_profit > 0
ORDER BY i.pe ASC
LIMIT 10;
```

#### Запрос 2: Компании с высокой дивидендной доходностью
```sql
-- Дивидендные аристократы: доходность > 8%, payout ratio < 80%
SELECT
    c.ticker,
    c.name,
    d.dividend_yield * 100 AS yield_percent,
    d.payout_ratio * 100 AS payout_percent,
    d.amount_per_share,
    d.ex_dividend_date
FROM companies c
JOIN dividends d ON c.id = d.company_id
WHERE
    d.ex_dividend_date >= CURRENT_DATE - INTERVAL '1 year'
    AND d.dividend_yield > 0.08
    AND d.payout_ratio < 0.80
ORDER BY d.dividend_yield DESC;
```

#### Запрос 3: Сравнение компаний по секторам
```sql
-- Средние показатели по секторам
SELECT
    s.name AS sector,
    COUNT(DISTINCT c.id) AS companies_count,
    ROUND(AVG(i.pe), 2) AS avg_pe,
    ROUND(AVG(i.roe * 100), 2) AS avg_roe_percent,
    ROUND(AVG(i.debt_to_equity), 2) AS avg_debt_equity,
    ROUND(AVG(i.net_profit_margin * 100), 2) AS avg_margin_percent,
    ROUND(SUM(m.market_cap) / 1e9, 2) AS total_market_cap_bln
FROM sectors s
JOIN companies c ON s.id = c.sector_id
JOIN reports r ON c.id = r.company_id AND r.report_period = 'ANNUAL'
JOIN metrics m ON r.id = m.report_id
JOIN indicators i ON r.id = i.report_id
WHERE r.report_year = EXTRACT(YEAR FROM CURRENT_DATE) - 1
GROUP BY s.id, s.name
HAVING COUNT(DISTINCT c.id) >= 3
ORDER BY total_market_cap_bln DESC;
```

### 10.2 Запросы для анализа компании

#### Запрос 4: Полный профиль компании
```sql
-- Детальная информация о компании с последними метриками
SELECT
    c.ticker,
    c.name,
    c.ceo,
    c.employees,
    s.name AS sector,
    r.report_year,
    r.report_period,

    -- Выручка и прибыль
    m.revenue / 1e6 AS revenue_mln,
    m.net_profit / 1e6 AS net_profit_mln,
    m.ebitda / 1e6 AS ebitda_mln,

    -- Баланс
    m.total_assets / 1e6 AS assets_mln,
    m.total_equity / 1e6 AS equity_mln,
    (m.long_term_debt + m.short_term_debt) / 1e6 AS total_debt_mln,

    -- Мультипликаторы
    i.pe,
    i.pb,
    i.ev_ebitda,

    -- Рентабельность
    i.roe * 100 AS roe_percent,
    i.roa * 100 AS roa_percent,
    i.net_profit_margin * 100 AS margin_percent,

    -- Рост
    i.revenue_growth_yoy * 100 AS revenue_growth_percent,
    i.profit_growth_yoy * 100 AS profit_growth_percent

FROM companies c
JOIN sectors s ON c.sector_id = s.id
JOIN reports r ON c.id = r.company_id
JOIN metrics m ON r.id = m.report_id
JOIN indicators i ON r.id = i.report_id
WHERE c.ticker = 'SBER'  -- Параметр: тикер компании
ORDER BY r.report_year DESC, r.report_period DESC
LIMIT 1;
```

#### Запрос 5: Динамика показателей компании за 5 лет
```sql
-- Тренд финансовых показателей
SELECT
    r.report_year,
    m.revenue / 1e9 AS revenue_bln,
    m.net_profit / 1e9 AS profit_bln,
    m.free_cash_flow / 1e9 AS fcf_bln,
    i.roe * 100 AS roe_percent,
    i.debt_to_equity AS de_ratio,
    i.revenue_growth_yoy * 100 AS growth_percent
FROM companies c
JOIN reports r ON c.id = r.company_id
JOIN metrics m ON r.id = m.report_id
JOIN indicators i ON r.id = i.report_id
WHERE
    c.ticker = 'GAZP'  -- Параметр
    AND r.report_period = 'ANNUAL'
    AND r.report_year >= EXTRACT(YEAR FROM CURRENT_DATE) - 5
ORDER BY r.report_year ASC;
```

#### Запрос 6: Расчет справедливой стоимости (DCF-lite)
```sql
-- Упрощенная оценка на основе FCF
WITH company_fcf AS (
    SELECT
        c.id,
        c.ticker,
        c.name,
        m.free_cash_flow,
        m.shares_outstanding,
        m.share_price,
        i.revenue_growth_yoy AS growth_rate
    FROM companies c
    JOIN reports r ON c.id = r.company_id
    JOIN metrics m ON r.id = m.report_id
    JOIN indicators i ON r.id = i.report_id
    WHERE
        r.report_period = 'ANNUAL'
        AND r.report_year = EXTRACT(YEAR FROM CURRENT_DATE) - 1
        AND m.free_cash_flow > 0
)
SELECT
    ticker,
    name,
    ROUND(free_cash_flow / 1e9, 2) AS fcf_bln,
    ROUND(share_price, 2) AS current_price,

    -- Простая модель: FCF * (1 + g) / (r - g), где r = 12%, g = growth_rate
    ROUND(
        (free_cash_flow * (1 + COALESCE(growth_rate, 0.05))) /
        (0.12 - LEAST(COALESCE(growth_rate, 0.05), 0.10)) /
        shares_outstanding,
    2) AS fair_value,

    ROUND(
        ((free_cash_flow * (1 + COALESCE(growth_rate, 0.05))) /
        (0.12 - LEAST(COALESCE(growth_rate, 0.05), 0.10)) /
        shares_outstanding - share_price) / share_price * 100,
    1) AS upside_percent

FROM company_fcf
ORDER BY upside_percent DESC
LIMIT 20;
```

### 10.3 Запросы для управления портфелем

#### Запрос 7: Состав портфеля с текущими ценами
```sql
-- Показать позиции портфеля с расчетом P&L
SELECT
    c.ticker,
    c.name,
    p.quantity,
    p.avg_price,
    m.share_price AS current_price,
    ROUND(p.quantity * p.avg_price, 2) AS cost_basis,
    ROUND(p.quantity * m.share_price, 2) AS market_value,
    ROUND(p.quantity * (m.share_price - p.avg_price), 2) AS unrealized_pnl,
    ROUND((m.share_price / p.avg_price - 1) * 100, 2) AS return_percent
FROM portfolio pf
JOIN position p ON pf.id = p.portfolio_id
JOIN companies c ON p.company_id = c.id
JOIN reports r ON c.id = r.company_id
JOIN metrics m ON r.id = m.report_id
WHERE
    pf.user_id = 1  -- Параметр: ID пользователя
    AND pf.name = 'Основной'  -- Параметр: имя портфеля
    AND r.id = (
        SELECT id FROM reports
        WHERE company_id = c.id
        ORDER BY report_year DESC, report_period DESC
        LIMIT 1
    )
ORDER BY market_value DESC;
```

#### Запрос 8: Суммарная статистика портфеля
```sql
-- Агрегированные показатели портфеля
WITH portfolio_data AS (
    SELECT
        pf.id AS portfolio_id,
        pf.name AS portfolio_name,
        c.ticker,
        p.quantity,
        p.avg_price,
        m.share_price,
        p.quantity * p.avg_price AS cost,
        p.quantity * m.share_price AS value,
        i.pe,
        i.roe,
        d.dividend_yield
    FROM portfolio pf
    JOIN position p ON pf.id = p.portfolio_id
    JOIN companies c ON p.company_id = c.id
    JOIN reports r ON c.id = r.company_id
    JOIN metrics m ON r.id = m.report_id
    JOIN indicators i ON r.id = i.report_id
    LEFT JOIN (
        SELECT company_id, MAX(dividend_yield) AS dividend_yield
        FROM dividends
        WHERE ex_dividend_date >= CURRENT_DATE - INTERVAL '1 year'
        GROUP BY company_id
    ) d ON c.id = d.company_id
    WHERE
        pf.user_id = 1
        AND r.id = (
            SELECT id FROM reports
            WHERE company_id = c.id
            ORDER BY report_year DESC, report_period DESC
            LIMIT 1
        )
)
SELECT
    portfolio_name,
    COUNT(*) AS positions_count,
    ROUND(SUM(cost), 2) AS total_cost,
    ROUND(SUM(value), 2) AS total_value,
    ROUND(SUM(value) - SUM(cost), 2) AS total_pnl,
    ROUND((SUM(value) / SUM(cost) - 1) * 100, 2) AS total_return_percent,
    ROUND(SUM(pe * value) / NULLIF(SUM(value), 0), 2) AS weighted_pe,
    ROUND(SUM(roe * value) / NULLIF(SUM(value), 0) * 100, 2) AS weighted_roe_percent,
    ROUND(SUM(COALESCE(dividend_yield, 0) * value) / NULLIF(SUM(value), 0) * 100, 2) AS expected_yield_percent
FROM portfolio_data
GROUP BY portfolio_id, portfolio_name;
```

#### Запрос 9: Диверсификация портфеля по секторам
```sql
-- Распределение портфеля по секторам
SELECT
    s.name AS sector,
    COUNT(*) AS positions,
    ROUND(SUM(p.quantity * m.share_price), 2) AS sector_value,
    ROUND(
        SUM(p.quantity * m.share_price) * 100.0 /
        SUM(SUM(p.quantity * m.share_price)) OVER (),
    2) AS weight_percent
FROM portfolio pf
JOIN position p ON pf.id = p.portfolio_id
JOIN companies c ON p.company_id = c.id
JOIN sectors s ON c.sector_id = s.id
JOIN reports r ON c.id = r.company_id
JOIN metrics m ON r.id = m.report_id
WHERE
    pf.user_id = 1
    AND pf.name = 'Основной'
    AND r.id = (
        SELECT id FROM reports
        WHERE company_id = c.id
        ORDER BY report_year DESC, report_period DESC
        LIMIT 1
    )
GROUP BY s.id, s.name
ORDER BY sector_value DESC;
```

### 10.4 Статистические и аналитические запросы

#### Запрос 10: Рейтинг компаний по качеству бизнеса
```sql
-- Комплексный scoring на основе фундаментальных показателей
WITH company_scores AS (
    SELECT
        c.ticker,
        c.name,
        s.name AS sector,
        i.roe,
        i.roa,
        i.debt_to_equity,
        i.current_ratio,
        i.net_profit_margin,
        i.revenue_growth_yoy,
        i.fcf_yield,

        -- Scoring components (0-100)
        LEAST(100, GREATEST(0, i.roe * 100 * 5)) AS roe_score,
        LEAST(100, GREATEST(0, i.roa * 100 * 10)) AS roa_score,
        LEAST(100, GREATEST(0, 100 - i.debt_to_equity * 20)) AS leverage_score,
        LEAST(100, GREATEST(0, i.current_ratio * 30)) AS liquidity_score,
        LEAST(100, GREATEST(0, i.net_profit_margin * 100 * 4)) AS margin_score,
        LEAST(100, GREATEST(0, 50 + i.revenue_growth_yoy * 100 * 2)) AS growth_score

    FROM companies c
    JOIN sectors s ON c.sector_id = s.id
    JOIN reports r ON c.id = r.company_id
    JOIN indicators i ON r.id = i.report_id
    WHERE
        r.report_period = 'ANNUAL'
        AND r.report_year = EXTRACT(YEAR FROM CURRENT_DATE) - 1
        AND i.roe IS NOT NULL
)
SELECT
    ticker,
    name,
    sector,
    ROUND(roe * 100, 2) AS roe_percent,
    ROUND(debt_to_equity, 2) AS de_ratio,
    ROUND(net_profit_margin * 100, 2) AS margin_percent,
    ROUND(revenue_growth_yoy * 100, 2) AS growth_percent,

    -- Composite score (weighted average)
    ROUND(
        roe_score * 0.25 +
        roa_score * 0.15 +
        leverage_score * 0.20 +
        liquidity_score * 0.10 +
        margin_score * 0.15 +
        growth_score * 0.15,
    1) AS quality_score

FROM company_scores
WHERE roe_score > 0
ORDER BY quality_score DESC
LIMIT 20;
```

#### Запрос 11: История дивидендов с расчетом CAGR
```sql
-- Compound Annual Growth Rate дивидендов за 5 лет
WITH dividend_history AS (
    SELECT
        c.id,
        c.ticker,
        c.name,
        EXTRACT(YEAR FROM d.ex_dividend_date) AS div_year,
        SUM(d.amount_per_share) AS annual_dividend
    FROM companies c
    JOIN dividends d ON c.id = d.company_id
    WHERE d.ex_dividend_date >= CURRENT_DATE - INTERVAL '5 years'
    GROUP BY c.id, c.ticker, c.name, EXTRACT(YEAR FROM d.ex_dividend_date)
),
dividend_cagr AS (
    SELECT
        id,
        ticker,
        name,
        MIN(div_year) AS start_year,
        MAX(div_year) AS end_year,
        MIN(annual_dividend) FILTER (WHERE div_year = (SELECT MIN(div_year) FROM dividend_history dh2 WHERE dh2.id = dividend_history.id)) AS start_div,
        MAX(annual_dividend) FILTER (WHERE div_year = (SELECT MAX(div_year) FROM dividend_history dh2 WHERE dh2.id = dividend_history.id)) AS end_div,
        COUNT(DISTINCT div_year) AS years_with_dividends
    FROM dividend_history
    GROUP BY id, ticker, name
    HAVING COUNT(DISTINCT div_year) >= 3
)
SELECT
    ticker,
    name,
    years_with_dividends,
    ROUND(start_div, 2) AS first_div,
    ROUND(end_div, 2) AS last_div,
    ROUND(
        (POWER(end_div / NULLIF(start_div, 0), 1.0 / (end_year - start_year)) - 1) * 100,
    2) AS dividend_cagr_percent
FROM dividend_cagr
WHERE start_div > 0 AND end_div > 0
ORDER BY dividend_cagr_percent DESC;
```

#### Запрос 12: Анализ затрат на AI
```sql
-- Статистика использования AI по пользователям и типам
SELECT
    u.id AS user_id,
    u.name,
    sub.level AS subscription,
    ai.analysis_type,
    COUNT(*) AS requests_count,
    SUM(ai.tokens_used) AS total_tokens,
    ROUND(SUM(ai.cost_usd), 2) AS total_cost_usd,
    ROUND(AVG(ai.tokens_used), 0) AS avg_tokens_per_request,
    MIN(ai.created_at) AS first_request,
    MAX(ai.created_at) AS last_request
FROM users u
JOIN (
    SELECT DISTINCT ON (user_id)
        user_id, level
    FROM subscriptions
    ORDER BY user_id, start_date DESC
) sub ON u.id = sub.user_id
CROSS JOIN ai_analyses ai  -- В реальности нужна связь user -> company analysis
WHERE ai.created_at >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY u.id, u.name, sub.level, ai.analysis_type
ORDER BY total_cost_usd DESC;
```

---

## 11. Группировка запросов в транзакции

### 11.1 Транзакция: Регистрация нового пользователя

```sql
-- Атомарное создание пользователя с аутентификацией
BEGIN;

-- Шаг 1: Создать запись пользователя
INSERT INTO users (name, status)
VALUES ('Иван Петров', 'active')
RETURNING id INTO @user_id;

-- Шаг 2: Создать аутентификацию
INSERT INTO auth (user_id, email, password_hash)
VALUES (@user_id, 'ivan@example.com', '$2a$12$...');

-- Шаг 3: Создать бесплатную подписку
INSERT INTO subscriptions (user_id, level, start_date)
VALUES (@user_id, 'free', NOW());

-- Шаг 4: Создать дефолтный портфель
INSERT INTO portfolio (user_id, name, description)
VALUES (@user_id, 'Основной', 'Мой первый портфель');

COMMIT;
```

### 11.2 Транзакция: Добавление позиции в портфель

```sql
-- Атомарное добавление/обновление позиции
BEGIN;

-- Проверить существование портфеля
SELECT id INTO @portfolio_id
FROM portfolio
WHERE user_id = 1 AND name = 'Основной'
FOR UPDATE;

IF @portfolio_id IS NULL THEN
    ROLLBACK;
    RAISE EXCEPTION 'Портфель не найден';
END IF;

-- Получить ID компании
SELECT id INTO @company_id
FROM companies
WHERE ticker = 'SBER';

-- Upsert позиции (добавить или обновить)
INSERT INTO position (portfolio_id, company_id, avg_price, quantity, last_buy_date)
VALUES (@portfolio_id, @company_id, 250.50, 100, NOW())
ON CONFLICT (portfolio_id, company_id)
DO UPDATE SET
    avg_price = (
        position.avg_price * position.quantity +
        EXCLUDED.avg_price * EXCLUDED.quantity
    ) / (position.quantity + EXCLUDED.quantity),
    quantity = position.quantity + EXCLUDED.quantity,
    last_buy_date = EXCLUDED.last_buy_date,
    updated_at = NOW();

COMMIT;
```

### 11.3 Транзакция: Загрузка финансового отчета

```sql
-- Атомарная загрузка отчета с метриками и индикаторами
BEGIN;

-- Шаг 1: Создать запись отчета
INSERT INTO reports (company_id, report_year, report_period, report_storage_url)
VALUES (
    (SELECT id FROM companies WHERE ticker = 'SBER'),
    2024,
    'ANNUAL',
    's3://reports/sber-2024-annual.pdf'
)
RETURNING id INTO @report_id;

-- Шаг 2: Загрузить метрики
INSERT INTO metrics (
    report_id, revenue, cost_of_revenue, gross_profit,
    net_profit, total_assets, total_equity, free_cash_flow,
    shares_outstanding, market_cap, share_price
)
VALUES (
    @report_id,
    7500000000000,  -- 7.5 трлн выручки
    4500000000000,  -- 4.5 трлн себестоимость
    3000000000000,  -- 3 трлн валовая прибыль
    1500000000000,  -- 1.5 трлн чистая прибыль
    50000000000000, -- 50 трлн активы
    7000000000000,  -- 7 трлн капитал
    800000000000,   -- 800 млрд FCF
    21586948000,    -- акций
    6500000000000,  -- 6.5 трлн капитализация
    301.15          -- цена акции
);

-- Шаг 3: Рассчитать и загрузить индикаторы
INSERT INTO indicators (
    report_id, pe, pb, ps, roe, roa,
    net_profit_margin, debt_to_equity, current_ratio, fcf_yield
)
SELECT
    @report_id,
    m.market_cap / NULLIF(m.net_profit, 0) AS pe,
    m.market_cap / NULLIF(m.total_equity, 0) AS pb,
    m.market_cap / NULLIF(m.revenue, 0) AS ps,
    m.net_profit / NULLIF(m.total_equity, 0) AS roe,
    m.net_profit / NULLIF(m.total_assets, 0) AS roa,
    m.net_profit / NULLIF(m.revenue, 0) AS net_profit_margin,
    (m.total_assets - m.total_equity) / NULLIF(m.total_equity, 0) AS debt_to_equity,
    m.current_assets / NULLIF(m.current_liabilities, 0) AS current_ratio,
    m.free_cash_flow / NULLIF(m.market_cap, 0) AS fcf_yield
FROM metrics m
WHERE m.report_id = @report_id;

COMMIT;
```

### 11.4 Транзакция: Обновление подписки

```sql
-- Атомарное обновление подписки с проверкой лимитов
BEGIN;

-- Завершить текущую подписку
UPDATE subscriptions
SET end_date = NOW()
WHERE user_id = 1
  AND end_date IS NULL
  AND start_date <= NOW();

-- Создать новую подписку
INSERT INTO subscriptions (user_id, level, start_date, end_date)
VALUES (1, 'premium', NOW(), NOW() + INTERVAL '1 month');

-- Проверить лимит портфелей (Premium = 5)
DO $$
DECLARE
    portfolio_count INT;
    portfolio_limit INT;
BEGIN
    SELECT COUNT(*) INTO portfolio_count
    FROM portfolio WHERE user_id = 1;

    SELECT CASE
        WHEN level = 'free' THEN 1
        WHEN level = 'premium' THEN 5
        ELSE 999999
    END INTO portfolio_limit
    FROM subscriptions
    WHERE user_id = 1 AND end_date IS NULL;

    IF portfolio_count > portfolio_limit THEN
        RAISE WARNING 'У пользователя больше портфелей, чем позволяет новая подписка';
    END IF;
END $$;

COMMIT;
```

### 11.5 Транзакция: Кэширование AI-анализа

```sql
-- Атомарное сохранение AI-анализа с дедупликацией
BEGIN;

-- Попытка вставить новый анализ
INSERT INTO ai_analyses (
    company_id, report_id, analysis_type, prompt_hash,
    response_text, tokens_used, cost_usd, cache_until
)
VALUES (
    (SELECT id FROM companies WHERE ticker = 'GAZP'),
    (SELECT r.id FROM reports r
     JOIN companies c ON r.company_id = c.id
     WHERE c.ticker = 'GAZP'
     ORDER BY r.report_year DESC LIMIT 1),
    'full',
    'sha256_hash_of_prompt_here',
    'Анализ компании Газпром показывает...',
    4500,
    0.15,
    NOW() + INTERVAL '7 days'
)
ON CONFLICT (prompt_hash)
DO UPDATE SET
    cache_until = NOW() + INTERVAL '7 days',
    -- Не обновляем response_text и cost — это кэш-хит
    created_at = ai_analyses.created_at;

COMMIT;
```

---

## 12. Заключение

Данная пояснительная записка описывает проектирование базы данных для системы Trade Compass — платформы анализа российских акций с AI-ассистентом.

### Ключевые результаты:

1. **Определены 14 сущностей** с четкими связями и ограничениями
2. **Схема нормализована до BCNF** — устранены все аномалии
3. **Разработано 12 SQL-запросов** для реализации функциональных требований
4. **Определено 5 транзакций** для атомарных операций

### Особенности реализации:

- Разделение аутентификации (email + OAuth) в отдельные таблицы
- Отделение расчетных индикаторов от сырых метрик
- Кэширование AI-анализа с дедупликацией по prompt_hash
- Поддержка мультипортфельности с уникальностью позиций

### Технологии:

- **СУБД:** PostgreSQL 17
- **Язык:** SQL (DDL + DML)
- **Индексация:** B-tree индексы на FK и часто фильтруемых полях

---

*Документ подготовлен для курса "Базы данных" Дергилёвым Марком*
*Проект: Trade Compass*
*Дата: декабрь 2025*
