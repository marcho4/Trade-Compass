# Bull Run

Платформа для анализа акций российских компаний с AI помощником

## Авторизация и регистрация в приложении

Возможен вход по Yandex через Open ID Connect, также по обычной регистрации с подтверждением Email.
При отправке заявки на регистрацию, в базу данных записывается хэшированный токен для подтверждения регистрации и данные пользователя. Ссылка с токеном придет пользователю на почту, так он подтвердит свою регистрацию. TTL токена 24 часа. Максимум 3 запроса на емейл в час.

Если пользователь пытается зарегистрироваться с почтой из Oauth, то мы скажем, что произошла ошибка при регистрации. Для 1 почты 1 способ входа.
"Проверьте, не существует ли аккаунт с такой почтой со входом через провайдеров".

Можно отправить письмо повторно при попытке авторизации в не подтвержденный аккаунт.
В данных от провайдера проверяем, является ли email подтвержденным или нет. Если нет - просим пользователя подтвердить его у провайдера.

Очищаем неподтвержденные аккаунты раз в неделю.

При 5 попытках неправильного логина даем рейт лимит и создаем алерт в мониторинге.

Пароль минимум 8 символов с 1 заглавной буквой, 1 цифрой и 1 спец символом.

Смена пароля: генерируется токен и отправляется ссылка на смену на почту. ТТЛ = 30 мин
При смене пароля проверяем токен.

Сессия пользователей будет поддерживаться через JWT токены. Access token с ттл 1 час - хранится в http only cookie на фронте и refresh token с ттл 30 дней, который будет храниться в бд в отдельной табличке.
- **Payload JWT токена:**
```json
  {
    "sub": "user_id",
    "email": "user@example.com",
    "role": "user",
    "iat": 1234567890,
    "exp": 1234571490
  }
```

Миддлвейр будет автоматически пробовать рефрешить access token, если он стух. Если не удалось зарефрешить, то тогда выкидываем 401 Unauthorized. При смене пароля удаляем все рефреш токены для пользователя.
